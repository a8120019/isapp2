<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <link href="index.css" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();

        $(document).ready(function () {
            addUser();
            getUserData();
        });

        async function addUser() {
            var me = await osql.getMe();
            // var student_id = "1" + me.id.substring(1, 8);
            // console.log(student_id);
            var sql = `insert ignore into Users values ("${me.id}", "${me.fname}", "${me.lname}");`;
            await osql.connect(sql);
        }

        async function getUserData() {
            var me = await osql.getMe();
            document.getElementById('student_name').innerHTML = me.fname;
            var sql = `select * from Fingering where userid = "${me.id}";`;
            var fingering = await osql.connect(sql);
            console.log(fingering);
            var html = "<table border='1'>";
            for (var i = 0; i < fingering.length; i++) {
                html = html + '<tr>';
                var object = fingering[i];
                html = html + '<td>' + (i + 1) + '</td>';
                html = html + '<td>' + `<a href="personal.html" onclick = "storeRec(${object.fingerid}, '${me.fname}')">` + "記録" + "</a>" + '</td>';
                html = html + '<td>' + `<button onclick="addRecord('${object.fingerid}')">運指入力</button>` + '</td>';
                html = html + '<td>' + object.date + '</td>';
                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('student_list').innerHTML = html;
        }

        function storeRec(finger_id, fname) {
            sessionStorage.setItem('store_id', finger_id);
            sessionStorage.setItem('fname', fname);
        }

        function addRecord(finger_id) {
            sessionStorage.setItem('finger_id', finger_id);
            window.location.href = "key_test.html";
        }

        function addNewRecord() {
            sessionStorage.removeItem('id');
            sessionStorage.removeItem('name');
            window.location.href = "add.html";
        }

        async function addButtonPressed() {
            var movie = document.getElementById('addURL').value;
            var me = await osql.getMe();
            var sql = `insert into Fingering (userid, movieURL, date) values ("${me.id}", "${movie}", now());`;
            await osql.connect(sql);

            var sql = `select * from Fingering where userid = "${me.id}" order by fingerid desc;`;
            var yubi = await osql.connect(sql);
            var catch_fingerid = yubi[0].fingerid;

            var key_list = ["Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P", "BackSpace", "A", "S", "D", "F", "G", "H", "J", "K", "L", ";", "Enter", "Z", "X", "C", "V", "B", "N", "M", ",", ".", "/", "Space"];
            for (var i = 0; i < key_list.length; i++) {
                var sql = `insert into Key_Finger (id, text) values (${catch_fingerid}, "${key_list[i]}");`;
                await osql.connect(sql);
            }
            getUserData();

            document.getElementById('addURL').value = "";
        }

        async function resetButtonPressed() {
            var me = await osql.getMe();
            var sql = `delete from Fingering where userid = "${me.id}";`;
            await osql.connect(sql);
            var sql = `delete from Key_Finger;`;
            await osql.connect(sql);
            var sql = "ALTER TABLE `Fingering` auto_increment = 1;";
            await osql.connect(sql);
            window.location.reload();
        }

    </script>

</head>

<body>
    <h1>学生ページ</h1>
    ようこそ、<span id="student_name"></span>さん
    <hr>
    <br>
    <input id="addURL" type="url" placeholder="動画URLを入力"><button id="add_movie"
        onclick="addButtonPressed()">動画追加</button>
    <button id="remove_movie" onclick="resetButtonPressed()">リセット</button>
    <br><br>
    <span id="student_list"></span>
</body>

</html>