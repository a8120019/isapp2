<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <link href="index.css" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();

        $(document).ready(function () {
            getUserData();
        });

        async function getUserData() {
            var me = await osql.getMe();
            var sql = `select * from Fingering where userid = "${me.id}";`;
            var fingering = await osql.connect(sql);
            console.log(fingering);
            var html = "<table border='1'>";
            for (var i = 0; i < fingering.length; i++) {
                html = html + '<tr>';
                var object = fingering[i];
                html = html + '<td>' + (i + 1) + '</td>';
                html = html + '<td>' + '<a href="personal.html?userid=' + object.name + '">' + "記録" + "</a>" + '</td>';
                html = html + '<td>' + `<button onclick="addRecord('${object.studentid}')">運指入力</button>` + '</td>';
                html = html + '<td>' + object.date + '</td>';
                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('student_list').innerHTML = html;
        }

        async function searchButtonPressed() {
            var s_name = document.getElementById('search').value;
            var sql = `select * from Users where name like "%${s_name}%";`;
            var students = await osql.connect(sql);
            var html = "<table border='1'>" + "<tr><th>" + "学生番号" + "</th><th>" + "名前" + "</th><th>" + "記録追加" + "</th><th>" + "生徒情報変更" + "</th></tr>";
            for (var i = 0; i < students.length; i++) {
                html = html + '<tr>';
                var object = students[i];
                html = html + '<td>' + object.studentid + '</td>';
                html = html + '<td>' + '<a href="personal.html?userid=' + object.name + '">' + object.name + "</a>" + '</td>';
                html = html + '<td>' + `<button onclick="addRecord('${object.studentid}')">記録追加</button>` + '</td>';
                html = html + '<td>' + `<button onclick="changeStudentInfo('${object.studentid}')">生徒情報変更</button>` + '</td>';
                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('student_list').innerHTML = html;
        }

        function addRecord(student_id, student_name) {
            sessionStorage.setItem('studentid', student_id);
            sessionStorage.setItem('name', student_name);
            window.location.href = "add.html";
        }

        function addNewRecord() {
            sessionStorage.removeItem('id');
            sessionStorage.removeItem('name');
            window.location.href = "add.html";
        }

        async function addButtonPressed() {
            var movie = document.getElementById('addURL').value;
            var me = await osql.getMe();
            var sql = `insert into Fingering (userid, movieURL, date) values ("${me.id}", "${movie}", now());`;
            await osql.connect(sql);

            var sql = `select * from Fingering where userid = "${me.id}" order by fingerid desc;`;
            var yubi = await osql.connect(sql);
            var catch_fingerid = yubi[0].fingerid;
            console.log(catch_fingerid);

            var key_list = ["Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P", "BackSpace", "A", "S", "D", "F", "G", "H", "J", "K", "L", ";", "Enter", "Z", "X", "C", "V", "B", "N", "M", ",", ".", "/", "Space"];
            for (var i = 0;i < key_list.length;i++){
                var sql = `insert into Key_Finger (id, text) values (${catch_fingerid}, "${key_list[i]}");`;
                await osql.connect(sql);
            }
        }

    </script>

</head>

<body>
    <h1>学生ページ</h1>
    <hr>
    <input id="addURL" type="url" placeholder="動画URLを入力"><button id="add_movie" onclick="addButtonPressed()">動画追加</button>
    <br><br>
    <span id="student_list"></span>
</body>

</html>