<html>

<head>
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();
        
        $(document).ready(function () {
            userName();
            // timer = setInterval(pageUpdate, 2000);
        });

        async function userName() {
            var me = await osql.getMe();
            document.getElementById('answerer').innerHTML = me.fname;
            // console.log(me);
        }

        async function getPop(){
            var sql = `select count(*) as count from Game_Play where gameid=1;`;
            var objects = await osql.connect(sql);
            var pop = Number(objects[0].count);  // 人数
            return pop;
        }

        async function buttonPressed() {
            var me = await osql.getMe();
            var ans = document.getElementById('answer').value;
            var sql = `select * from Game_Play where playerid="${me.id}";`;
            var objects = await osql.connect(sql);

            var sql = `select * from Game where id=1;`;
            var games = await osql.connect(sql);

            var sumorder = Number(games[0].turn) + 1;

            var sql = `insert into Item values (${objects[0].gameid}, "${objects[0].playerid}", ${sumorder}, "${ans}");`;
            await osql.connect(sql);
            var sql = `update Game set turn = ${sumorder} where id=${objects[0].gameid};`;
            await osql.connect(sql);

            document.getElementById('answerer').innerHTML = "つぎのひと";
            document.getElementById('form').innerHTML = "";
        }

        async function pageUpdate(){
            // window.location.reload();
            var pop = getPop();
            var sql = `select * from Game where id=1;`;
            var objects = await osql.connect(sql);
            var phase = Number(objects[0].turn);
            var check = phase % pop;
            var me = await osql.getMe();
            var sql = `select * from Game_Play where playerid="${me.id}";`;
            var objects = await osql.connect(sql);
            console.log(check);
            console.log(objects);
            if (check == objects[0].orders){
                document.getElementById('answerer').innerHTML = me.fname;
                document.getElementById('form').innerHTML = `<input id="answer"><button id = "confirm" onclick = "buttonPressed()" > 入力</button>`;
            } else if (check == 0){
                document.getElementById('answerer').innerHTML = me.fname;
                document.getElementById('form').innerHTML = `<input id="answer"><button id = "confirm" onclick = "buttonPressed()" > 入力</button>`;
            }
        }

    </script>
</head>

<body>
    <h1>山手線ゲーム</h1>
    <hr>
    <span id="answerer"></span>さんの番です
    <p>
        <span id="form">
        <input id="answer">
        <button id="confirm" onclick="buttonPressed()">入力</button>
        </span>
        <button id="update" onclick="pageUpdate()">更新</button>
    </p>
</body>

</html>